<html>
    <head>
	<link type="text/css" href="/public/css/style.css" rel="stylesheet"/>
	<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    </head>
    <body>
	<p>Whoopie starting again!</p>
	<img src="/public/img/sun.png" width=50px height=50px />
	<select id="boards">
	</select>
	<select id="cards"></select>
    </body>

    <script type="text/javascript">
     xhr = new XMLHttpRequest();
     xhr.onreadystatechange = function () {
	 var DONE = 4;
	 var OK = 200;
	 if (xhr.readyState === DONE) {
	     if (xhr.status === OK) { 
		 console.log(xhr.responseText);
	     } else {
		 console.log('Error: ' + xhr.status);
	     }
	 }
     };

	 var boards = document.getElementById('boards'),
	 cards = document.getElementById('cards'),
	 toReadyStateDescription = function (state) {
	     switch(state) {
		 case 0:
		     return 'UNSENT';
		 case 1:
		     return 'OPENED';
		 case 2:
		     return 'HEADERS_RECEIVED';
		 case 3:
		     return 'LOADING';
		 case 4:
		     return 'DONE';
		 default:
		     return '';
	     }
	 };

     function formatBoards(boardsJ) {
	 var listHTML = "";
	 for (var i = 0; i < boardsJ.length; i++) {
	     var currentBoard = boardsJ[i];
	     listHTML = listHTML + `<option value="${currentBoard.id}">${currentBoard.name}</option>`; 
	 }
	 return listHTML;
     }

     function formatCards(cardsJ) {
	 var listHTML = "";
	 for (var i = 0; i < cardsJ.length; i++) {
	     var currentCard = cardsJ[i];
	     listHTML = listHTML + `<option value="${currentCard.id}">${currentCard.name}</option>`; 
	 }
	 return listHTML;
     }
     
     window.onload = function() {
	 console.log("getBoards pressed");
	 var oReq = new XMLHttpRequest();
	 oReq.onload = function(e) {
	     console.log("request in state onload");
	     
	     boards.innerHTML = formatBoards(JSON.parse(e.target.response).message);
	 };
	 oReq.onreadystatechange = function() {
	     var readyState = toReadyStateDescription(oReq.readyState);
	     console.log("request ready state change: ", readyState);
	 }; 
	     oReq.open('GET', '/getBoards', true);
	     oReq.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
	     oReq.send();
     };

     boards.addEventListener('change', function (e) {
	 console.log("Board selected");
	 var oReq = new XMLHttpRequest();
	 oReq.onload = function(e) {
	     console.log("request in state onload");
	     cards.innerHTML = formatCards(JSON.parse(e.target.response).message);
	 };
	 oReq.onreadystatechange = function() {
	     var readyState = toReadyStateDescription(oReq.readyState);
	     console.log("request ready state change: ", readyState);
	 }; 
	     oReq.open('GET', '/getCards' + '?boardId=' + boards.options[boards.selectedIndex].value, true);
	     oReq.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
	     oReq.send();
     });
    </script> 
    <script type="text/javascript">

     var margin = {top: 20, right: 20, bottom: 30, left: 40},
	 width = 960 - margin.left - margin.right,
	 height = 500 - margin.top - margin.bottom;

     var x = d3.scale.ordinal()
	       .rangeRoundBands([0, width], .1);

     var y = d3.scale.linear()
	       .range([height, 0]);

     var xAxis = d3.svg.axis()
		   .scale(x)
		   .orient("bottom");

     var yAxis = d3.svg.axis()
		   .scale(y)
		   .orient("left")
		   .ticks(10, "%");

     var svg = d3.select("body").append("svg")
		 .attr("width", width + margin.left + margin.right)
		 .attr("height", height + margin.top + margin.bottom)
		 .append("g")
		 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
     
    function buildGraph(error, data) {
	 if (error) throw error;

	 x.domain(data.map(function(d) { return d.day; }));
	 y.domain([0, d3.max(data, function(d) { return d.seconds; })]);

	 svg.append("g")
	    .attr("class", "x axis")
	    .attr("transform", "translate(0," + height + ")")
	    .call(xAxis);

	 svg.append("g")
	    .attr("class", "y axis")
	    .call(yAxis)
	    .append("text")
	    .attr("transform", "rotate(-90)")
	    .attr("y", 6)
	    .attr("dy", ".71em")
	    .style("text-anchor", "end")
	    .text("seconds");

	 svg.selectAll(".bar")
	    .data(data)
	    .enter().append("rect")
	    .attr("class", "bar")
	    .attr("x", function(d) { return x(d.day); })
	    .attr("width", x.rangeBand())
	    .attr("y", function(d) { return y(d.seconds); })
	    .attr("height", function(d) { return height - y(d.seconds); });
     };

	var testData = [
	    {
		day: '0',
		seconds: 360,
	    },
	    {
		day: '1',
		seconds: 45,
	    }
	];
	
     buildGraph(null, testData);

     function type(d) {
	 d.frequency = +d.frequency;
	 return d;
     }
    </script>

</html>
